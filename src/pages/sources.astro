---
// –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ (–∞–≤—Ç–æ—Ä–∞–º–∏ –¥–Ω–µ–≤–Ω–∏–∫–æ–≤)
import Navbar from '../components/Navbar.astro';
import Sidebar from '../components/Sidebar.astro';
import '../styles/global.css';
import { readFileSync } from 'fs';
import { join } from 'path';

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –¥–ª—è TypeScript
interface Point {
  title: string;
  lat: number;
  lng: number;
  date: string;
  quote: string;
  context: string;
  author: string;
  author_link: string;
  type?: string;
}

interface DataFile {
  points: Point[];
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∞–≤—Ç–æ—Ä–∞–º
function getAllSourcesData() {
  try {
    // –ß–∏—Ç–∞–µ–º JSON —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç–æ—á–µ–∫
    const dataPath = join(process.cwd(), 'public', 'data', 'points.json');
    const fileContent = readFileSync(dataPath, 'utf-8');
    const data: DataFile = JSON.parse(fileContent);
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –∞–≤—Ç–æ—Ä–∞–º –∏—Å–ø–æ–ª—å–∑—É—è Map
    const authorMap = new Map<string, {
      author: string;
      author_link: string;
      points: Point[];
    }>();
    
    if (data.points && Array.isArray(data.points)) {
      data.points.forEach(point => {
        if (!authorMap.has(point.author)) {
          authorMap.set(point.author, {
            author: point.author,
            author_link: point.author_link,
            points: []
          });
        }
        authorMap.get(point.author)!.points.push(point);
      });
    }
    
    return Array.from(authorMap.values());
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:', error);
    return [];
  }
}

const sources = getAllSourcesData();
---

<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ - –§—Ä–æ–Ω—Ç–æ–≤—ã–µ –î–Ω–µ–≤–Ω–∏–∫–∏ –í–û–í</title>
    <meta name="description" content="–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–æ–≤ –¥–Ω–µ–≤–Ω–∏–∫–æ–≤ –∏ –∏—Ö –∑–∞–ø–∏—Å–µ–π">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  </head>
  <body>
    <Navbar />
    <Sidebar />
    <main>
      <div class="page-container">
        <div class="container">
          <h1 class="page-title">üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏</h1>
          
          <div class="sources-grid">
            {sources.map(source => (
              <div class="source-card">
                <h3>{source.author}</h3>
                <a href={source.author_link} class="author-link" target="_blank">
                  üë§ –ü—Ä–æ—Ñ–∏–ª—å "–ü—Ä–æ–∂–∏—Ç–æ"
                </a>
                <p class="source-count">
                  üí¨ –ó–∞–ø–∏—Å–µ–π: <strong>{source.points.length}</strong>
                </p>
                
                <div class="quotes-list">
                  {source.points.map(point => (
                    <div class="quote-item">
                      <div class="date">
                        üìÖ {new Date(point.date).toLocaleDateString('ru-RU', { 
                          year: 'numeric', 
                          month: 'long', 
                          day: 'numeric' 
                        })}
                      </div>
                      <div class="location">üìç {point.title}</div>
                      <div class="text">
                        "{point.quote.substring(0, 100)}{point.quote.length > 100 ? '...' : ''}"
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
          
          <div class="back-button">
            <a href="/" class="button">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ä—Ç–µ</a>
          </div>
        </div>
      </div>
    </main>
  </body>
</html>
