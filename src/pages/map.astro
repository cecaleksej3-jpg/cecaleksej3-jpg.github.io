---
// map.astro - Страница с интерактивной картой
import Navbar from '../components/Navbar.astro';
import Sidebar from '../components/Sidebar.astro';
import { SITE_VERSION } from '../config';
import '../styles/global.css';
---

<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивная карта - Фронтовые Дневники ВОВ</title>
    <meta name="description" content="Интерактивная карта дневников фронтовиков Великой Отечественной войны">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" />
  </head>
  <body>
    <Navbar />
    <Sidebar />
    <main class="map-container">
      <div id="map"></div>
      
      <!-- Информация об использовании ИИ и источниках данных -->
      <div class="info-badge" id="info-badge">
        <button class="info-badge-close" id="info-badge-close" aria-label="Закрыть">✕</button>
        <div class="info-badge-content">
          <span class="info-icon">🤖</span>
          <div class="info-text">
            <p class="info-ai">Создано с использованием ИИ<br><span class="badge-version">{SITE_VERSION}</span></p>
            <p class="info-source">Исторические данные: <a href="https://corpus.prozhito.org/" target="_blank" rel="noopener noreferrer">corpus.prozhito.org</a></p>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Обработка закрытия информационной плашки
      window.addEventListener('DOMContentLoaded', () => {
        const infoBadge = document.getElementById('info-badge');
        const infoBadgeClose = document.getElementById('info-badge-close');
        
        if (infoBadge && infoBadgeClose) {
          infoBadgeClose.addEventListener('click', () => {
            infoBadge.classList.add('fade-out');
            setTimeout(() => {
              infoBadge.style.display = 'none';
            }, 300);
          });
        }
      });

      // Основная функция для инициализации карты
      async function initializeMap() {
        // Функция форматирования даты
        function formatDate(dateString) {
          if (!dateString) return 'Дата неизвестна';

          const [year, month, day] = dateString.split('-').map(Number);

          if (!year) return 'Дата неизвестна';

          if (month === 0 && day === 0) {
            return `${year} год`;
          }

          if (day === 0) {
            const monthNames = [
              'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
              'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];
            
            if (month < 1 || month > 12) {
              return `${year} год`;
            }

            return `${monthNames[month - 1]} ${year} года`;
          }

          try {
            const date = new Date(year, month - 1, day);
            
            if (isNaN(date.getTime())) {
              return `${year} год`;
            }

            const options = {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            };

            return new Intl.DateTimeFormat('ru-RU', options).format(date);
          } catch {
            return `${year} год`;
          }
        }
        
        // Подгружаем библиотеку Leaflet динамически
        const L = (await import('leaflet')).default;
        
        // Создаем карту с центром на Санкт-Петербурге и масштабом 6
        // Координаты: широта 59.9343, долгота 30.3351
        const map = L.map('map').setView([59.9343, 30.3351], 6);
        
        // Добавляем слой OpenStreetMap (бесплатные карты)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors',
          maxZoom: 19,
        }).addTo(map);
        
        // Функция возвращает путь к иконке маркера в зависимости от типа события
        // Типы: default (обычное), death (смерть), good (положительное)
        function getIconUrl(type) {
          const icons = {
            'default': '/assets/icons/marker-default.svg',
            'death': '/assets/icons/marker-death.svg',
            'good': '/assets/icons/marker-good.svg'
          };
          // Если тип не найден, возвращаем иконку по умолчанию
          return icons[type] || icons['default'];
        }
        
        // Создание кастомной иконки для маркера
        function createCustomIcon(type) {
          return L.icon({
            iconUrl: getIconUrl(type),
            iconSize: [32, 40],        // Размер иконки
            iconAnchor: [16, 40],       // Точка привязки к координатам
            popupAnchor: [0, -40],      // Смещение всплывающего окна
            className: `marker-${type}` // CSS класс для дополнительной стилизации
          });
        }
        
        // Загружаем данные о точках из JSON файла
        try {
          const response = await fetch('/data/points.json');
          const data = await response.json();
          
          // Проверяем что данные загрузились корректно
          if (data.points && Array.isArray(data.points)) {
            // Проходим по каждой точке и создаем маркер
            data.points.forEach(point => {
              const marker = L.marker(
                [point.lat, point.lng],
                { icon: createCustomIcon(point.type || 'default') }
              ).addTo(map);
              
              // Формируем HTML контент для всплывающего окна (popup)
              // Показываем название, дату, цитату, контекст и автора
              const popupContent = `
                <div class="marker-popup">
                  <h3>${point.title}</h3>
                  <div class="date">${formatDate(point.date)}</div>
                  <div class="quote">"${point.quote}"</div>
                  <div class="context">${point.context}</div>
                  <div class="author">
                    — <a href="${point.author_link}" target="_blank">${point.author}</a>
                  </div>
                </div>
              `;
              
              // Привязываем popup к маркеру
              marker.bindPopup(popupContent, {
                maxWidth: 300,
                className: 'popup-custom'
              });
            });
          }
        } catch (error) {
          // Выводим ошибку в консоль если не удалось загрузить данные
          console.error('Ошибка при загрузке маркеров:', error);
        }
      }
      
      // Запускаем инициализацию карты после загрузки страницы
      // Проверяем готовность документа
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeMap);
      } else {
        // Если страница уже загружена, запускаем сразу
        initializeMap();
      }
    </script>

    <style>
      /* Информационная плашка на карте */
      .info-badge {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(139, 157, 111, 0.95);
        backdrop-filter: blur(10px);
        border: 2px solid var(--color-khaki-dark);
        border-radius: 8px;
        padding: 12px 16px 12px 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        max-width: 350px;
        animation: slideInRight 0.5s ease-out;
        opacity: 1;
        transition: opacity 0.3s ease-out;
        position: relative;
      }

      .info-badge.fade-out {
        opacity: 0;
      }

      .info-badge-close {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.3);
        border: none;
        color: var(--color-cream);
        font-size: 18px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        line-height: 1;
        padding: 0;
      }

      .info-badge-close:hover {
        background: rgba(0, 0, 0, 0.6);
        transform: scale(1.1);
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .info-badge-content {
        display: flex;
        align-items: center;
        gap: 12px;
        padding-right: 20px;
      }

      .info-icon {
        font-size: 28px;
        flex-shrink: 0;
      }

      .info-text {
        flex: 1;
      }

      .info-text p {
        margin: 0;
        line-height: 1.4;
        color: var(--color-cream);
      }

      .info-ai {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 4px !important;
        letter-spacing: 0.03em;
      }

            .badge-version {
        font-size: 10px;
        opacity: 0.7;
        font-weight: 600;
        letter-spacing: 0.05em;
        display: block;
        margin-top: 4px;
      }

      .badge-version {
        font-size: 10px;
        opacity: 0.7;
        font-weight: 600;
        letter-spacing: 0.05em;
        display: block;
        margin-top: 4px;
      }

      .info-source {
        font-size: 11px;
        opacity: 0.9;
      }

      .info-source a {
        color: #FFD700;
        text-decoration: none;
        font-weight: 600;
        border-bottom: 1px solid transparent;
        transition: border-color 0.3s ease;
      }

      .info-source a:hover {
        border-bottom-color: #FFD700;
      }

      /* Responsive для info badge */
      @media (max-width: 768px) {
        .info-badge {
          bottom: 15px;
          right: 15px;
          max-width: 300px;
          padding: 10px 12px;
        }

        .info-icon {
          font-size: 24px;
        }

        .info-ai {
          font-size: 12px;
        }

              .badge-version {
        font-size: 10px;
        opacity: 0.7;
        font-weight: 600;
        letter-spacing: 0.05em;
        display: block;
        margin-top: 4px;
      }

      .badge-version {
        font-size: 10px;
        opacity: 0.7;
        font-weight: 600;
        letter-spacing: 0.05em;
        display: block;
        margin-top: 4px;
      }

      .info-source {
          font-size: 10px;
        }
      }

      @media (max-width: 480px) {
        .info-badge {
          bottom: 10px;
          right: 10px;
          max-width: 280px;
          padding: 8px 10px;
        }

        .info-badge-content {
          gap: 8px;
        }

        .info-icon {
          font-size: 20px;
        }

        .info-ai {
          font-size: 11px;
        }

              .badge-version {
        font-size: 10px;
        opacity: 0.7;
        font-weight: 600;
        letter-spacing: 0.05em;
        display: block;
        margin-top: 4px;
      }

      .badge-version {
        font-size: 10px;
        opacity: 0.7;
        font-weight: 600;
        letter-spacing: 0.05em;
        display: block;
        margin-top: 4px;
      }

      .info-source {
          font-size: 9px;
        }
      }
    </style>
  </body>
</html>

