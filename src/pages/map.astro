---
// map.astro - Страница с интерактивной картой
import Navbar from '../components/Navbar.astro';
import Sidebar from '../components/Sidebar.astro';
import { SITE_VERSION } from '../config';
import '../styles/global.css';
---

<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивная карта - Фронтовые Дневники ВОВ</title>
    <meta name="description" content="Интерактивная карта дневников фронтовиков Великой Отечественной войны">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=PT+Serif:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  </head>
  <body>
    <Navbar />
    <Sidebar />
    <main class="map-container">
      <div id="map"></div>
      
      <!-- Информация об использовании ИИ и источниках данных -->
      <div class="info-badge" id="info-badge">
        <button class="info-badge-close" id="info-badge-close" aria-label="Закрыть">✕</button>
        <div class="info-badge-content">
          <span class="info-icon">🤖</span>
          <div class="info-text">
            <p class="info-ai">Создано с использованием ИИ<br><span class="badge-version">{SITE_VERSION}</span></p>
            <p class="info-source">Исторические данные: <a href="https://corpus.prozhito.org/" target="_blank" rel="noopener noreferrer">corpus.prozhito.org</a></p>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Обработка закрытия информационной плашки
      window.addEventListener('DOMContentLoaded', () => {
        const infoBadge = document.getElementById('info-badge');
        const infoBadgeClose = document.getElementById('info-badge-close');
        
        if (infoBadge && infoBadgeClose) {
          infoBadgeClose.addEventListener('click', () => {
            infoBadge.classList.add('fade-out');
            setTimeout(() => {
              infoBadge.style.display = 'none';
            }, 300);
          });
        }
      });

      // Основная функция для инициализации карты
      async function initializeMap() {
        // Функция форматирования даты
        function formatDate(dateString) {
          if (!dateString) return 'Дата неизвестна';

          const [year, month, day] = dateString.split('-').map(Number);

          if (!year) return 'Дата неизвестна';

          if (month === 0 && day === 0) {
            return `${year} год`;
          }

          if (day === 0) {
            const monthNames = [
              'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
              'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ];
            
            if (month < 1 || month > 12) {
              return `${year} год`;
            }

            return `${monthNames[month - 1]} ${year} года`;
          }

          try {
            const date = new Date(year, month - 1, day);
            
            if (isNaN(date.getTime())) {
              return `${year} год`;
            }

            const options = {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            };

            return new Intl.DateTimeFormat('ru-RU', options).format(date);
          } catch {
            return `${year} год`;
          }
        }
        
        // Подгружаем библиотеку Leaflet динамически
        const L = (await import('leaflet')).default;
        
        // Получаем параметры из URL для центровки карты
        const urlParams = new URLSearchParams(window.location.search);
        const paramLatStr = urlParams.get('lat');
        const paramLngStr = urlParams.get('lng');
        const paramZoomStr = urlParams.get('zoom');
        const paramLat = paramLatStr ? parseFloat(paramLatStr) : NaN;
        const paramLng = paramLngStr ? parseFloat(paramLngStr) : NaN;
        const paramZoom = paramZoomStr ? parseInt(paramZoomStr) : 6;
        
        // Если есть параметры, центруем на них, иначе на Санкт-Петербурге
        const centerLat = isNaN(paramLat) ? 59.9343 : paramLat;
        const centerLng = isNaN(paramLng) ? 30.3351 : paramLng;
        
        // Создаем карту с центром на переданных координатах или на Санкт-Петербурге
        const map = L.map('map').setView([centerLat, centerLng], paramZoom);
        
        // Добавляем слой OpenStreetMap (бесплатные карты)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors',
          maxZoom: 19,
        }).addTo(map);
        
        // Функция возвращает путь к иконке маркера в зависимости от типа события
        // Типы: default (обычное), death (смерть), good (положительное)
        function getIconUrl(type) {
          const icons = {
            'default': '/assets/icons/marker-default.svg',
            'death': '/assets/icons/marker-death.svg',
            'good': '/assets/icons/marker-good.svg'
          };
          // Если тип не найден, возвращаем иконку по умолчанию
          return icons[type] || icons['default'];
        }
        
        // Создание кастомной иконки для маркера
        function createCustomIcon(type) {
          return L.icon({
            iconUrl: getIconUrl(type),
            iconSize: [32, 40],        // Размер иконки
            iconAnchor: [16, 40],       // Точка привязки к координатам
            popupAnchor: [0, -40],      // Смещение всплывающего окна
            className: `marker-${type}` // CSS класс для дополнительной стилизации
          });
        }
        
        // Загружаем данные о точках из JSON файла
        try {
          const response = await fetch('/data/points.json');
          const data = await response.json();
          
          // Проверяем что данные загрузились корректно
          if (data.points && Array.isArray(data.points)) {
            // Проходим по каждой точке и создаем маркер
            data.points.forEach(point => {
              const marker = L.marker(
                [point.lat, point.lng],
                { icon: createCustomIcon(point.type || 'default') }
              ).addTo(map);
              
              // Формируем HTML контент для всплывающего окна (popup)
              // Показываем название, дату, цитату, контекст и автора
              const popupContent = `
                <div class="marker-popup">
                  <h3>${point.title}</h3>
                  <div class="date">${formatDate(point.date)}</div>
                  <div class="quote">"${point.quote}"</div>
                  <div class="context">${point.context}</div>
                  <div class="author">
                    — <a href="${point.author_link}" target="_blank">${point.author}</a>
                  </div>
                </div>
              `;
              
              // Привязываем popup к маркеру
              marker.bindPopup(popupContent, {
                maxWidth: 300,
                className: 'popup-custom'
              });
            });
          }
        } catch (error) {
          // Выводим ошибку в консоль если не удалось загрузить данные
          console.error('Ошибка при загрузке маркеров:', error);
        }
      }
      
      // Запускаем инициализацию карты после загрузки страницы
      // Проверяем готовность документа
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeMap);
      } else {
        // Если страница уже загружена, запускаем сразу
        initializeMap();
      }
    </script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background-color: #12100e;
        color: #F7F5EF;
        min-height: 100vh;
        position: relative;
        overflow: hidden;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image: 
          radial-gradient(circle at 15% 25%, rgba(247, 245, 239, 0.04) 0%, transparent 50%),
          radial-gradient(circle at 85% 75%, rgba(247, 245, 239, 0.03) 0%, transparent 50%),
          repeating-linear-gradient(45deg, transparent, transparent 80px, rgba(247, 245, 239, 0.012) 80px, rgba(247, 245, 239, 0.012) 160px);
        pointer-events: none;
        z-index: 0;
      }

      .map-container {
        position: fixed;
        top: 80px;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
        transition: top 0.3s ease;
      }

      .map-container.fullscreen {
        top: 0;
      }

      #map {
        height: 100%;
        width: 100%;
        border-radius: 0;
      }

      /* Информационная плашка */
      .info-badge {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1001;
        background: linear-gradient(135deg, rgba(18, 21, 18, 0.92), rgba(12, 14, 12, 0.94));
        backdrop-filter: blur(14px);
        border: 1px solid rgba(247, 245, 239, 0.18);
        border-radius: 14px;
        padding: 16px 20px 16px 16px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.5);
        max-width: 380px;
        animation: slideInRight 0.5s ease-out;
        opacity: 1;
        transition: opacity 0.3s ease-out;
        position: relative;
      }

      .info-badge.fade-out {
        opacity: 0;
      }

      .info-badge-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(247, 245, 239, 0.08);
        border: 1px solid rgba(247, 245, 239, 0.15);
        color: #F7F5EF;
        font-size: 16px;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        line-height: 1;
        padding: 0;
        font-weight: 700;
      }

      .info-badge-close:hover {
        background: rgba(247, 245, 239, 0.18);
        transform: scale(1.05);
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .info-badge-content {
        display: flex;
        align-items: center;
        gap: 14px;
        padding-right: 24px;
      }

      .info-icon {
        font-size: 32px;
        flex-shrink: 0;
      }

      .info-text {
        flex: 1;
      }

      .info-text p {
        margin: 0;
        line-height: 1.5;
        color: #F7F5EF;
      }

      .info-ai {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 6px !important;
        letter-spacing: 0.04em;
        color: #F7F5EF;
      }

      .badge-version {
        font-size: 11px;
        opacity: 0.65;
        font-weight: 600;
        letter-spacing: 0.06em;
        display: block;
        margin-top: 5px;
        color: rgba(247, 245, 239, 0.7);
      }

      .info-source {
        font-size: 12px;
        opacity: 0.85;
        color: rgba(247, 245, 239, 0.85);
      }

      .info-source a {
        color: #F7F5EF;
        text-decoration: none;
        font-weight: 600;
        border-bottom: 1px solid rgba(247, 245, 239, 0.3);
        transition: all 0.3s ease;
      }

      .info-source a:hover {
        border-bottom-color: #F7F5EF;
        color: #fff;
      }

      /* Стили попапов маркеров */
      .leaflet-popup-content-wrapper {
        background: linear-gradient(135deg, rgba(18, 21, 18, 0.96), rgba(12, 14, 12, 0.98));
        backdrop-filter: blur(12px);
        border: 1px solid rgba(247, 245, 239, 0.2);
        border-radius: 12px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6);
        padding: 0;
      }

      .leaflet-popup-content {
        margin: 0;
        font-family: 'Inter', sans-serif;
      }

      .marker-popup {
        padding: 18px 20px;
        color: #F7F5EF;
      }

      .marker-popup h3 {
        font-family: 'PT Serif', serif;
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 10px 0;
        color: #F7F5EF;
        letter-spacing: 0.02em;
      }

      .marker-popup .date {
        font-size: 12px;
        color: rgba(247, 245, 239, 0.7);
        margin-bottom: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }

      .marker-popup .quote {
        font-family: 'PT Serif', serif;
        font-style: italic;
        font-size: 15px;
        line-height: 1.6;
        margin: 12px 0;
        padding-left: 12px;
        border-left: 3px solid rgba(247, 245, 239, 0.3);
        color: rgba(247, 245, 239, 0.95);
      }

      .marker-popup .context {
        font-size: 13px;
        line-height: 1.6;
        margin: 12px 0;
        color: rgba(247, 245, 239, 0.8);
      }

      .marker-popup .author {
        font-size: 13px;
        font-weight: 600;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(247, 245, 239, 0.15);
        color: rgba(247, 245, 239, 0.9);
      }

      .marker-popup .author a {
        color: #F7F5EF;
        text-decoration: none;
        border-bottom: 1px solid rgba(247, 245, 239, 0.3);
        transition: all 0.3s ease;
      }

      .marker-popup .author a:hover {
        color: #fff;
        border-bottom-color: #F7F5EF;
      }

      .leaflet-popup-tip {
        background: rgba(18, 21, 18, 0.96);
        border: 1px solid rgba(247, 245, 239, 0.2);
        border-top: none;
        border-left: none;
      }

      .leaflet-popup-close-button {
        color: rgba(247, 245, 239, 0.7) !important;
        font-size: 22px !important;
        font-weight: 700 !important;
        padding: 6px 10px !important;
        transition: color 0.3s ease;
      }

      .leaflet-popup-close-button:hover {
        color: #F7F5EF !important;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .map-container {
          top: 70px;
        }

        .info-badge {
          bottom: 18px;
          right: 18px;
          max-width: 320px;
          padding: 14px 18px;
        }

        .info-icon {
          font-size: 28px;
        }

        .info-ai {
          font-size: 13px;
        }

        .marker-popup {
          padding: 16px 18px;
        }

        .marker-popup h3 {
          font-size: 16px;
        }
      }

      @media (max-width: 480px) {
        .map-container {
          top: 60px;
        }

        .info-badge {
          bottom: 12px;
          right: 12px;
          max-width: 280px;
          padding: 12px 14px;
        }

        .info-badge-content {
          gap: 10px;
        }

        .info-icon {
          font-size: 24px;
        }

        .info-ai {
          font-size: 12px;
        }

        .info-source {
          font-size: 11px;
        }

        .marker-popup {
          padding: 14px 16px;
        }

        .marker-popup h3 {
          font-size: 15px;
        }

        .marker-popup .quote {
          font-size: 14px;
        }
      }
    </style>
  </body>
</html>

